<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Tìm Kiếm Sản Phẩm</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            height: 100vh;
        }
        #sidebar {
            width: 250px;
            background-color: #ffffff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        #sidebar h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #5b9bd5;
            padding-bottom: 10px;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        #upload-btn, #reset-btn {
            flex: 1;
            padding: 10px;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #upload-btn {
            background-color: #5b9bd5;
        }
        #upload-btn:hover {
            background-color: #4a8ac9;
        }
        #reset-btn {
            background-color: #6c757d;
        }
        #reset-btn:hover {
            background-color: #5a6268;
        }
        #tag-search {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }
        #processing-message {
            text-align: center;
            color: #777;
            margin-bottom: 10px;
        }
        #tag-results-display {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #495057;
        }
        #tag-filters {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* Style for category headings */
        .category-header {
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1em;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-header:first-of-type {
            margin-top: 5px;
        }
        .toggle-icon {
            font-weight: bold;
            font-size: 1.2em;
        }
        .checkbox-group.collapsed {
            display: none;
        }
        .checkbox-group label {
            display: block;
            margin: 8px 0 8px 5px;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .checkbox-group label:hover {
            background-color: #e9f2fa;
        }
        .checkbox-group input {
            margin-right: 10px;
            transform: scale(1.2);
        }
        #main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .product-card {
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Aligns items to the top */
        }
        .product-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .product-details {
            flex-grow: 1;
        }
        .product-card h3 {
            margin-top: 0;
            margin-bottom: 5px;
            color: #333;
            font-size: 1.2em;
        }
        .product-type {
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
        }
        .product-card a {
            color: #5b9bd5;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
        }
        .product-card a:hover {
            text-decoration: underline;
        }
        .product-card .tags {
            margin-top: 15px;
            font-size: 14px;
            color: #777;
        }
        .product-card .tags span {
            background-color: #eef;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 5px;
            display: inline-block;
            margin-bottom: 5px;
        }
        .image-container {
            display: flex;
            gap: 15px; /* Increased gap */
            margin-left: 20px;
            flex-shrink: 0;
        }
        .product-image-placeholder {
            width: 120px; /* Made wider */
            height: 100px;
            border: 1px solid #eee; /* Changed to solid for a cleaner look */
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-size: 14px;
            text-align: center;
            border-radius: 4px;
        }
        .product-image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Changed to contain to prevent cropping */
        }
        #no-results {
            color: #777;
            font-size: 18px;
            text-align: center;
            margin-top: 50px;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Lọc theo Thẻ</h2>
        <div class="button-container">
            <button id="upload-btn">Tải ảnh lên</button>
            <button id="reset-btn">Thiết lập lại</button>
        </div>
        <div id="processing-message" style="display: none;">Đang xử lý...</div>
        <div id="tag-results-display" style="display: none;"></div>
        <input type="text" id="tag-search" placeholder="Tìm kiếm thẻ...">
        <div id="tag-filters">
            <!-- Checkboxes will be generated here by JavaScript -->
        </div>
    </div>

    <div id="main-content">
        <div id="results">
            <!-- Product cards will be generated here by JavaScript -->
        </div>
        <div id="no-results" style="display: none;">
            <p>Không có sản phẩm nào khớp với tất cả các thẻ đã chọn.</p>
        </div>
    </div>

    <script>
        // --- DATA SOURCE ---
        const products = [
            { id: 301, name: "Áo khoác nữ", styleName: "S261440075", purchaseURL: "https://drive.google.com/file/d/1gVYjlQMl76yUpvXn6uVKcNWl61M6Elhg/view?usp=sharing", imageUrl1: "https://cdn.imgchest.com/files/yxkczk6jbm7.png", imageUrl2: "https://cdn.imgchest.com/files/49zc29qgm6y.png", tags: { type: ["Áo khoác"], gender: ["Nữ"], customer: ["DSI"], closure: ["Dây kéo"], neckline: ["Cổ đức"], sleeve: ["Của tay bo"], front_body: ["Bổ cầu ngực"], back_body: ["Túi 1 cơi"], hem: ["Gấu bo"] } },
            { id: 302, name: "Quần nam", styleName: "S261280008", purchaseURL: "https://drive.google.com/file/d/1SRvXS2vH9pvcyAZmeilM_ojsq_8atMnY/view?usp=sharing", imageUrl1: "https://cdn.imgchest.com/files/4nec8npwgk4.png", imageUrl2: "https://cdn.imgchest.com/files/7bwckezgaw7.png", tags: { type: ["Quần"], gender: ["Nam"], customer: ["DSI"], closure: ["Không dây kéo"], waistband: ["Thun"], front_pocket: ["Túi chéo"], back_pocket: ["Túi cơi"], hem: ["Gấu lật"] } },
            { id: 303, name: "Áo khoác nữ", styleName: "144J1147", purchaseURL: "https://drive.google.com/file/d/1dtj9O0fkyIONTwdMgzj5Ldc9UXqIoB0D/view?usp=sharing", imageUrl1: "https://cdn.imgchest.com/files/7pjcqd3xzo7.png", imageUrl2: "https://cdn.imgchest.com/files/7ogcbwm8gvy.png", tags: { type: ["Áo khoác"], gender: ["Nữ"], customer: ["DSI"], closure: ["Dây kéo"], neckline: ["Cổ tàu quai nhê"], sleeve: ["Cửa tay có xẻ khóa"], shoulder: ["Vai ốp"], front_body: ["Thân bổ"], hem: ["Gấu gập kín"] } },
            { id: 304, name: "Quần nam", styleName: "S261560089", purchaseURL: "https://drive.google.com/file/d/1SRvXS2vH9pvcyAZmeilM_ojsq_8atMnY/view?usp=sharing", imageUrl1: "https://cdn.imgchest.com/files/4nec8npwgk4.png", imageUrl2: "https://cdn.imgchest.com/files/7bwckezgaw7.png", tags: { type: ["Quần"], gender: ["Nam"], customer: ["DSI"], closure: ["Dây kéo"], waistband: ["Cạp liền"], front_pocket: ["Túi chéo"], back_pocket: ["Túi cơi"], hem: ["Gấu giấu mũi"] } }
        ];

        // --- SCRIPT LOGIC ---
        const filtersContainer = document.getElementById('tag-filters');
        const resultsContainer = document.getElementById('results');
        const noResultsMessage = document.getElementById('no-results');
        const tagSearchInput = document.getElementById('tag-search');
        const uploadBtn = document.getElementById('upload-btn');
        const resetBtn = document.getElementById('reset-btn');
        const processingMessage = document.getElementById('processing-message');
        const tagResultsDisplay = document.getElementById('tag-results-display');

        uploadBtn.addEventListener('click', processImageUpload);
        resetBtn.addEventListener('click', resetFilters);
        tagSearchInput.addEventListener('input', filterTags);

        // Function to clear all selected tags
        function resetFilters() {
            const allCheckboxes = filtersContainer.querySelectorAll('input[type="checkbox"]');
            allCheckboxes.forEach(cb => cb.checked = false);
            renderProducts();
        }

        // Function to simulate processing an image and matching tags
        function processImageUpload() {
            processingMessage.style.display = 'block';
            uploadBtn.disabled = true;
            resetBtn.disabled = true;
            uploadBtn.style.cursor = 'not-allowed';
            uploadBtn.style.backgroundColor = '#a0a0a0';

            resetFilters(); // Reset filters before starting

            setTimeout(() => {
                const fixedFoundTags = ["Nữ", "Áo khoác", "Dây kéo"];

                fixedFoundTags.forEach(tag => {
                    const checkbox = filtersContainer.querySelector(`input[value="${tag}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                renderProducts();

                processingMessage.style.display = 'none';
                uploadBtn.disabled = false;
                resetBtn.disabled = false;
                uploadBtn.style.cursor = 'pointer';
                uploadBtn.style.backgroundColor = '#5b9bd5';

            }, 2000); // 2-second delay
        }

        // Function to filter the visible tag checkboxes
        function filterTags() {
            const searchTerm = tagSearchInput.value.toLowerCase();
            const allLabels = filtersContainer.querySelectorAll('.checkbox-group label');

            allLabels.forEach(label => {
                const tagText = label.textContent.toLowerCase();
                if (tagText.includes(searchTerm)) {
                    label.style.display = 'block';
                } else {
                    label.style.display = 'none';
                }
            });
        }

        // Function to update the display of selected tags
        function updateSelectedTagsDisplay() {
            const selectedTags = Array.from(filtersContainer.querySelectorAll('input:checked')).map(input => input.value);
            
            if (selectedTags.length > 0) {
                tagResultsDisplay.innerHTML = `<strong>Các thẻ đã chọn:</strong><br>${selectedTags.join(', ')}`;
                tagResultsDisplay.style.display = 'block';
            } else {
                tagResultsDisplay.style.display = 'none';
            }
        }

        // Function to filter and display products based on selected tags
        function renderProducts() {
            updateSelectedTagsDisplay(); // Update the tag display every time products are rendered

            const selectedTags = Array.from(filtersContainer.querySelectorAll('input:checked')).map(input => input.value);
            
            const filteredProducts = products.filter(product => {
                const productTags = Object.values(product.tags).flat();
                return selectedTags.every(tag => productTags.includes(tag));
            });

            resultsContainer.innerHTML = '';

            if (filteredProducts.length > 0) {
                noResultsMessage.style.display = 'none';
                filteredProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    const allProductTags = Object.values(product.tags).flat();
                    const tagElements = allProductTags.map(tag => `<span>${tag}</span>`).join('');
                    
                    card.innerHTML = `
                        <div class="product-details">
                            <h3>${product.styleName}</h3>
                            <p class="product-type">${product.name}</p>
                            <a href="${product.purchaseURL}" target="_blank">Xem Mẫu Rập</a>
                            <div class="tags">Thẻ: ${tagElements}</div>
                        </div>
                        <div class="image-container">
                            <div class="product-image-placeholder">
                                <img src="${product.imageUrl1}" alt="Image 1 for ${product.name}" onerror="this.style.display='none'; this.parentElement.innerText='Ảnh 1 lỗi';">
                            </div>
                            <div class="product-image-placeholder">
                                <img src="${product.imageUrl2}" alt="Image 2 for ${product.name}" onerror="this.style.display='none'; this.parentElement.innerText='Ảnh 2 lỗi';">
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });
            } else {
                noResultsMessage.style.display = 'block';
            }
        }

        // Function to create the filter checkboxes from the categorized data
        function createFilters() {
            const allTagsCategorized = {}; 
            products.forEach(product => {
                for (const category in product.tags) {
                    // Skip empty tags
                    if(!product.tags[category] || product.tags[category].length === 0 || product.tags[category][0] === '') continue;

                    if (!allTagsCategorized[category]) {
                        allTagsCategorized[category] = new Set();
                    }
                    product.tags[category].forEach(tag => allTagsCategorized[category].add(tag));
                }
            });

            // Define the custom order and display names for categories
            const categoryOrder = ["type", "gender", "customer", "closure", "neckline", "sleeve", "shoulder", "front_body", "back_body", "hem", "waistband", "front_pocket", "back_pocket"];
            const categoryDisplayNames = {
                type: "Loại",
                gender: "Giới tính",
                customer: "Khách hàng",
                closure: "Kiểu cài",
                neckline: "Kiểu cổ",
                sleeve: "Kiểu tay",
                shoulder: "Vai",
                front_body: "Thân trước",
                back_body: "Thân sau",
                hem: "Kiểu gấu",
                waistband: "Kiểu cạp",
                front_pocket: "Túi trước",
                back_pocket: "Túi sau"
            };

            for (const category of categoryOrder) {
                if (!allTagsCategorized[category]) continue;

                const heading = document.createElement('h3');
                heading.className = 'category-header';
                heading.innerHTML = `
                    <span>${categoryDisplayNames[category] || category}</span>
                    <span class="toggle-icon">-</span>
                `;
                
                const checkboxGroup = document.createElement('div');
                checkboxGroup.className = 'checkbox-group';

                const sortedTags = Array.from(allTagsCategorized[category]).sort();
                sortedTags.forEach(tag => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = tag;
                    checkbox.addEventListener('change', renderProducts);

                    label.appendChild(checkbox);
                    label.append(` ${tag}`);
                    checkboxGroup.appendChild(label);
                });

                heading.addEventListener('click', () => {
                    checkboxGroup.classList.toggle('collapsed');
                    const icon = heading.querySelector('.toggle-icon');
                    icon.textContent = checkboxGroup.classList.contains('collapsed') ? '+' : '-';
                });

                filtersContainer.appendChild(heading);
                filtersContainer.appendChild(checkboxGroup);
            }
        }

        // --- INITIAL PAGE LOAD ---
        createFilters();
        renderProducts();
    </script>

</body>
</html>
